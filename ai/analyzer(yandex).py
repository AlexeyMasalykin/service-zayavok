import os
import re
import logging
import requests
import uuid
from dotenv import load_dotenv

load_dotenv()

# Переменные из окружения
FOLDER_ID = os.getenv("YA_FOLDER_ID")
API_KEY = os.getenv("YA_API_KEY")

# Константы Yandex
YANDEXGPT_URL = "https://llm.api.cloud.yandex.net/foundationModels/v1/completion"
HEADERS = {
    "Content-Type": "application/json",
    "Authorization": f"Api-Key {API_KEY}",
    "x-folder-id": FOLDER_ID
}

# Основная функция анализа
def analyze_with_ai(text: str) -> tuple[str, float]:
    try:
        prompt = f"""
Ты — специалист по снабжению. Твоя задача — оценить, насколько понятно сформулирована заявка на закупку с точки зрения возможности точно и однозначно определить нужный товар.
Обрати внимание на:
Насколько понятно, конкретно и точно описан предмет закупки.
Есть ли полные характеристики товаров, позволяющие исключить неоднозначность при выборе (тип, вид, параметры, размер, материал, модель и пр.).
Указаны ли единицы измерения и количество.
Является ли структура заявки удобной для дальнейшей работы (есть ли таблица, позиции, наименования).
Цена не влияет на оценку. Законодательные нормы (например, 44-ФЗ или 223-ФЗ) также не учитываются.
Описание объекта закупки тоже не влияет на общую оценку.
Не анализировать общее описание объекта закупки, только таблицу, характеристики, количество и единицы измерения.
Если в заявке:
1. В заявке не указаны конкретные характеристики товаров (например, размер перчаток, объём шприцев, длина и ширина бинтов и т. д.).
2. Не указано, какой именно тип упаковок используется для ваты и бинтов (например, вес в упаковке, количество в упаковке).
3. Не указаны дополнительные параметры, которые могут быть важны для некоторых товаров (например, стерильность, материал, из которого изготовлены товары).
Такую заявку пропускать нельзя
Шкала оценки:
    0–3 — заявка непригодна: невозможно понять, что именно требуется закупить.
    4–6 — заявка требует серьёзной доработки: много неясного или неоднозначного.
    7–9 — заявка пригодна, но желательны небольшие уточнения.
    10 — заявка идеальна: все товары описаны однозначно, снабженец точно поймёт, что покупать.

В ответе обязательно укажи:
    Замечания по содержанию (если есть).
    Пример, как можно улучшить заявку.
    Итоговая оценка: Рейтинг: X из 10.

Текст заявки:
{text}
"""

        body = {
            "modelUri": "gpt://{}/yandexgpt/latest".format(FOLDER_ID),
            "completionOptions": {
                "temperature": 0.2,
                "maxTokens": 1000,
                "stream": False
            },
            "messages": [
                {"role": "user", "text": prompt}
            ]
        }

        response = requests.post(YANDEXGPT_URL, headers=HEADERS, json=body)
        response.raise_for_status()
        content = response.json()["result"]["alternatives"][0]["message"]["text"].strip()

        match = re.search(r'рейтинг[:\s]*([0-9]+(?:[.,][0-9]*)?)\s*из\s*10', content.lower())
        rating = float(match.group(1).replace(',', '.')) if match else 0.0

        return content, rating

    except Exception as e:
        logging.error(f"❌ Ошибка анализа AI: {e}")
        return "⚠ Не удалось выполнить анализ", 0.0

