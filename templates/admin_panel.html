{% extends "base.html" %}
{% block title %}Админ-панель - Сервис заявок{% endblock %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
  <div class="ui-head text-start">
    <h2 class="mb-2">
      <i class="bi bi-shield-lock me-2 text-primary"></i>
      Администрирование заявок
    </h2>
    <p class="text-secondary mb-0">Управление, фильтрация и экспорт заявок в системе</p>
  </div>
  <div class="d-flex gap-2">
    <a href="{{ url_for('export_excel', **filters) }}" class="btn btn-success shadow-colored">
      <i class="bi bi-file-earmark-excel me-2"></i>Экспорт Excel
    </a>
  </div>
</div>

<!-- Панель фильтров -->
<div class="ui-card mb-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h6 class="fw-bold mb-0">
      <i class="bi bi-funnel me-2 text-primary"></i>
      Фильтры поиска
    </h6>
    <span class="badge bg-primary-subtle text-primary">{{ records|length }} заявок</span>
  </div>
  
  <form method="get">
    <div class="row g-3">
      <div class="col-lg-2 col-md-4">
        <label class="form-label small fw-semibold text-muted">ФИО заявителя</label>
        <input class="form-control" name="name" placeholder="Поиск по имени" value="{{ filters.name }}">
      </div>
      <div class="col-lg-2 col-md-4">
        <label class="form-label small fw-semibold text-muted">Филиал</label>
        <input class="form-control" name="department" placeholder="Поиск по филиалу" value="{{ filters.department }}">
      </div>
      <div class="col-lg-2 col-md-4">
        <label class="form-label small fw-semibold text-muted">Статус</label>
        <select class="form-select" name="status">
          <option value="">Все статусы</option>
          {% for s in ['новая', 'в работе', 'утверждена', 'отклонена', 'исполнена'] %}
            <option value="{{ s }}" {% if filters.status == s %}selected{% endif %}>{{ s.title() }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-lg-2 col-md-6">
        <label class="form-label small fw-semibold text-muted">Дата от</label>
        <input class="form-control" type="date" name="from_date" value="{{ filters.from_date }}">
      </div>
      <div class="col-lg-2 col-md-6">
        <label class="form-label small fw-semibold text-muted">Дата до</label>
        <input class="form-control" type="date" name="to_date" value="{{ filters.to_date }}">
      </div>
      <div class="col-lg-2 col-md-12 d-flex align-items-end">
        <div class="d-flex gap-2 w-100">
          <button class="btn btn-primary flex-fill">
            <i class="bi bi-search me-1"></i>Найти
          </button>
          <a href="{{ url_for('admin_panel') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-clockwise"></i>
          </a>
        </div>
      </div>
    </div>
  </form>
</div>

<!-- Таблица заявок -->
<div class="ui-card admin-table">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h6 class="fw-bold mb-0">
      <i class="bi bi-table me-2 text-primary"></i>
      Список заявок
    </h6>
    <small class="text-muted d-none d-md-block">
      <i class="bi bi-info-circle me-1"></i>
      Прокрутите таблицу горизонтально для просмотра всех данных
    </small>
  </div>
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0" style="min-width: 1200px;">
      <thead>
        <tr>
          <th class="fw-bold" style="width: 60px;">
            <i class="bi bi-hash me-1"></i>ID
          </th>
          <th class="fw-bold d-none d-lg-table-cell" style="width: 100px;">
            <i class="bi bi-calendar3 me-1"></i>Дата
          </th>
          <th class="fw-bold" style="width: 150px;">
            <i class="bi bi-person me-1"></i>ФИО
          </th>
          <th class="fw-bold d-none d-md-table-cell" style="width: 120px;">
            <i class="bi bi-building me-1"></i>Филиал
          </th>
          <th class="fw-bold d-none d-xl-table-cell" style="width: 200px;">
            <i class="bi bi-card-text me-1"></i>Описание
          </th>
          <th class="fw-bold text-center" style="width: 80px;">
            <i class="bi bi-star me-1"></i>Рейтинг
          </th>
          <th class="fw-bold" style="width: 140px;">
            <i class="bi bi-flag me-1"></i>Статус
          </th>
          <th class="fw-bold" style="width: 180px;">
            <i class="bi bi-chat-square-text me-1"></i>Примечание
          </th>

          <th class="fw-bold text-center" style="width: 60px;">
            <i class="bi bi-file-earmark-word me-1"></i>Word
          </th>
          <th class="fw-bold text-center" style="width: 80px;">Действия</th>
        </tr>
      </thead>
      <tbody>
      {% for r in records %}
        <tr>
          <form method="post">
            <input type="hidden" name="id" value="{{ r.id }}">
            <td>
              <span class="badge bg-primary-subtle text-primary fw-semibold">#{{ r.id }}</span>
            </td>
            <td class="text-nowrap small d-none d-lg-table-cell">
              {% if r.submitted_at %}
                <div class="fw-semibold small">{{ (r.submitted_at|moscow_time).strftime('%d.%m') }}</div>
                <div class="text-muted" style="font-size: 0.75rem;">{{ (r.submitted_at|moscow_time).strftime('%H:%M') }}</div>
              {% endif %}
            </td>
            <td>
              <div class="fw-semibold small text-truncate" style="max-width: 140px;" title="{{ r.name or '-' }}">{{ r.name or '-' }}</div>
              <small class="text-muted d-none d-md-block" style="font-size: 0.7rem;">{{ (r.position or 'Должность не указана')[:15] }}{% if (r.position or 'Должность не указана')|length > 15 %}...{% endif %}</small>
              <small class="text-muted d-lg-none" style="font-size: 0.65rem;">{{ (r.submitted_at|moscow_time).strftime('%d.%m %H:%M') if r.submitted_at else '' }}</small>
            </td>
            <td class="d-none d-md-table-cell">
              <span class="badge bg-secondary-subtle text-secondary small" style="font-size: 0.7rem;">{{ (r.department or '-')[:10] }}{% if (r.department or '-')|length > 10 %}...{% endif %}</span>
            </td>
            <td class="d-none d-xl-table-cell">
              <div class="text-truncate small" title="{{ r.description }}" style="max-width: 180px;">
                {{ (r.description or 'Описание отсутствует')[:30] }}{% if (r.description or 'Описание отсутствует')|length > 30 %}...{% endif %}
              </div>
              {% if r.cost %}
                <small class="text-success fw-semibold" style="font-size: 0.7rem;">{{ r.cost[:15] }}{% if r.cost|length > 15 %}...{% endif %}</small>
              {% endif %}
            </td>
            <td class="text-center">
              {% if r.rating %}
                {% set rating_class = 'success' if r.rating > 6 else 'warning' if r.rating > 3 else 'danger' %}
                <div class="d-flex align-items-center justify-content-center gap-1">
                  <span class="badge bg-{{ rating_class }}-subtle text-{{ rating_class }} fw-bold">
                    {{ '{:.1f}'.format(r.rating) }}
                  </span>
                  <i class="bi bi-star-fill text-{{ rating_class }}"></i>
                </div>
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            </td>
            <td>
              <select name="status" class="form-select form-select-sm" style="font-size: 0.75rem;">
                {% for s in ['новая', 'в работе', 'утверждена', 'отклонена', 'исполнена'] %}
                  <option value="{{ s }}" {% if r.status == s %}selected{% endif %}>{{ s.title() }}</option>
                {% endfor %}
              </select>
            </td>
            <td>
              <input name="note" value="{{ r.note or '' }}" 
                     class="form-control form-control-sm" 
                     style="font-size: 0.75rem; width: 160px;"
                     placeholder="Примечание...">
            </td>

            <td class="text-center">
              {% if r.is_manual %}
                <a class="btn btn-outline-warning btn-sm p-1" 
                   href="{{ url_for('manual.export_word', app_id=r.id) }}" 
                   title="Скачать Word"
                   style="width: 28px; height: 28px;">
                  <i class="bi bi-file-earmark-word" style="font-size: 0.75rem;"></i>
                </a>
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            </td>
            <td class="text-center">
              <button class="btn btn-success btn-sm p-1" 
                      title="Сохранить изменения"
                      style="width: 32px; height: 28px;">
                <i class="bi bi-check-lg" style="font-size: 0.8rem;"></i>
              </button>
            </td>
          </form>
        </tr>
      {% else %}
        <tr>
          <td colspan="10" class="text-center py-5 text-muted">
            <i class="bi bi-inbox fs-1 mb-3 d-block"></i>
            <h6>Заявки не найдены</h6>
            <p class="mb-0">Попробуйте изменить параметры фильтрации</p>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Статистика -->
{% if records %}
<div class="row g-4 mt-4">
  <div class="col-md-3">
    <div class="ui-subcard text-center">
      <i class="bi bi-file-earmark-plus text-primary fs-3 mb-2"></i>
      <div class="fw-bold">{{ records|selectattr('status', 'equalto', 'новая')|list|length }}</div>
      <small class="text-muted">Новых заявок</small>
    </div>
  </div>
  <div class="col-md-3">
    <div class="ui-subcard text-center">
      <i class="bi bi-gear text-warning fs-3 mb-2"></i>
      <div class="fw-bold">{{ records|selectattr('status', 'equalto', 'в работе')|list|length }}</div>
      <small class="text-muted">В работе</small>
    </div>
  </div>
  <div class="col-md-3">
    <div class="ui-subcard text-center">
      <i class="bi bi-check-circle text-success fs-3 mb-2"></i>
      <div class="fw-bold">{{ records|selectattr('status', 'equalto', 'утверждена')|list|length }}</div>
      <small class="text-muted">Утверждено</small>
    </div>
  </div>
  <div class="col-md-3">
    <div class="ui-subcard text-center">
      <i class="bi bi-star text-info fs-3 mb-2"></i>
      <div class="fw-bold">
        {{ '{:.1f}'.format((records|selectattr('rating')|map(attribute='rating')|sum) / (records|selectattr('rating')|list|length)) if records|selectattr('rating')|list|length > 0 else '0' }}
      </div>
      <small class="text-muted">Средний рейтинг</small>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}